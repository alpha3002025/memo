# 자주 사용하는 명령어들

시험 보기 전에 겁나 떨려서 뭐라도 반복적으로 봐야겠다 싶을때 보면 좋을것 같은 명령어들<br/>

<br/>



# Watch

쿠버네티스 명령어는 아니지만 꽤 자주 쓰는 명령어다. 걍 아무 때나 문서 보면서 반복적으로 보고 싶어서 명령어를 추가해서 정리했다.

```bash
$ watch kubectl get pods -o wide
```

<br/>



# Pod

## kubectl run

yaml 파일로 선언한 것을 구동시키는 것이 아니라 명령행에서 run 명령으로 실행하게 된다.

```bash
$ kubectl run web --image=nginx:1.14 --port=80
$ kubectl get pod -n devops
NAME READY STATUS RESTARTS AGE
web 1/1 Running 0 18s
$ kubectl delete pod web
```

<br/>



## kubectl run `--dry-run`

`--dry-run` 옵션을 주면 실제로 리소스를 생성하는 것은 아니고, 이 yaml 선언이 정상인지를 체크해볼 수 있도록 검증하는 방식으로 구동시키게 된다. 즉, 테스트 용으로 문법체크 등이 맞는지, 리소스 선언이 제대로 되었는지 등을 검사하는 작업을 수행하는 것이다.<br/>

`--dry-run` 의 결과를 yaml 파일로 저장

```bash
$ kubectl run web --image=nginx:1.14 --port=80 --dry-run -o yaml > web.yaml
$ vi web.yaml
$ kubectl apply -f web.yaml
$ kubectl get pod -n devops
$ kubectl delete pod -n devops web
```

<br/>



## kubectl describe

```bash
$ kubectl describe pod deploy-nginx-aaabbbccc
```



<br/>



# Deployment

```bash
kubectl create deployment webserver --image=nginx:1.14 --replicas=2 --dry-run=client -o yaml > webserver.yaml
```



## 롤링업데이트

서비스 중단 없이 새로운 버전으로 업데이트<br/>

아래 명령은 롤링업데이트를 수행하는데 그 과정을 기록하는 명령어<br/>

```bash
$ kubectl set image deployment deploy-nginx nginx-container=nginx:1.15 --record
```

<br/>



### 참고 : record 옵션

record 는 현재 deprecated 되었는데, 여기에 대해서는 아래 자료에서 자세히 설명해주고 있다.

- [--record 옵션을 대체하는 옵션이 있나요?](https://www.inflearn.com/community/questions/523283/record-%EC%98%B5%EC%85%98%EC%9D%84-%EB%8C%80%EC%B2%B4%ED%95%98%EB%8A%94-%EC%98%B5%EC%85%98%EC%9D%B4-%EC%9E%88%EB%82%98%EC%9A%94?srsltid=AfmBOoqc_I9Bzc5FPA3Rd_j9D18b5_V3N3nivTIG-kmb03ay00JGSC2k)

<br/>



## 롤백

서비스 중단없이 이전 버전으로 되돌리기<br/>

```bash
# 히스토리 확인 명령
kubectl rollout history deployment <deployment_name>

# undo
## 바로 이전 버전으로 rollback
kubectl rollout undo deployment <deployment_name>
## 과거의 특정 버전으로 rollback
kubectl rollout undo deployment <deployment_name> --to-revision=NUMBER
```

<br/>



# Node

## kubectl get nodes

node 들의 상태를 확인한다.kubectl get pods 와 가끔 혼동할때가 있다. 조심!!

```bash
$ kubectl get nodes
```

<br/>



## cordon

```bash
$ kubectl cordon {노드이름}
```

<br/>



## uncordon

```bash
$ kubectl uncordon {노드이름}
```

<br/>



## node drain

특정 node 에서 실행중인 pod 을 비우거나(drain) 제거(delete)

```bash
$ kubectl drain {노드명} --ignore-daemonsets --force
```

특정 노드의 인프라 환경을 교체하거나 네트워크 구성을 변경하거나 정비작업을 해야 하는 경우 그 노드를 사용하는 노드들을 비워줘야 하는데 이 경우 node drain 명령으로 그 노드에서 동작하는 파드 들을 비워줄 수 있다.<br/>

- `--ignore-daemonsets` : 그 노드 내에 동작중인 kube-proxy, kubelet 등과 같은 쿠버네티스 시스템에서 돌아가는 pod 들은 daemon 으로 동작하고 있고 이 것을 daemonset 이라고 부른다. 이러한 daemonset 에 해당하는 요소들을 정지시키지 않겠다는 의미다. 참고로 kube-proxy, kubelet 같은 프로세스가 종료되면 API Controller 가 해당 노드를 제어를 못하게 될 수 있다.
- `--force` : Controller (ReplicaSet, Job, DaemonSet 등)의 제어를 받지 않는 Pod 들도 삭제를 하겠다는 옵션이다. Static Pod 같은 파드 들 처럼 독립적으로 돌아가고 있는 파드 들도 정지시킬 수 있다.

<br/>



## 예제

- k8s-worker2 노드를 스케쥴링 불가능하게 설정하고 해당 노드에서 실행 중인 모든 Pod 들을 다른 Node 로 리스케쥴링하세요
- 답: k8s-worker2 를 node drain 해준다. 노드 드레인 시에 cordon 도 함께 수행된다.

<br/>



## 노드 정지 후 재개 절차

- cordon 으로 저지선을 세워서 새로운 pod 들이 유입되지 않도록 한다. cordon den 은 영어 단어로 '저지선'이라는 의미다.

- node drain \{노드명} \-\-ignore-daemonsets \-\-force 를 통해 해당 노드 내의 pod 들을 종료시키고 다른 노드로 재분배되게끔 하는 절차를 거친다.
- 노드 내에 새로운 작업을 마쳤거나 새로운 노드를 마련했다면, uncordon 을 통해서 새로운 pod 들이 유입될수 있도록 해준다.

<br/>

















